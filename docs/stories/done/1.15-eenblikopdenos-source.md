# Story 1.15: Add @eenblikopdenos (X/Twitter) as News Source

**Story ID:** 1.15
**Epic ID:** Epic 1 – RSS Ingestion & NLP Enrichment
**Status:** Complete

## Objective

Add the X/Twitter account [@eenblikopdenos](https://x.com/eenblikopdenos) as a news source to provide critical commentary on NOS reporting. This account analyses NOS coverage and highlights potential framing, omissions, or bias - making it ideal for the pluralistic news goal of this project.

## Background/Context

- **Source:** X/Twitter account @eenblikopdenos
- **Platform:** X (formerly Twitter)
- **Content:** Critical analysis and commentary on NOS news coverage
- **Language:** Dutch (nl)
- **Update Frequency:** Multiple tweets per day
- **Value:** Provides meta-commentary on NOS reporting, highlighting framing choices and potential bias
- **Clustering Strategy:** Should cluster with NOS events since tweets reference NOS articles directly

### Why This Source Matters

@eenblikopdenos serves as a "media watchdog" for the Dutch public broadcaster NOS. The account:
- Points out framing choices in NOS headlines
- Highlights what NOS covers vs. what it ignores
- Provides alternative perspectives on the same news events
- Often includes direct links/references to NOS articles

This makes it perfect for clustering with NOS events and showing different viewpoints on the same story.

### Technical Approach: Nitter RSS

Since the X/Twitter API is expensive ($100+/month), we use **Nitter** - a privacy-friendly Twitter frontend that provides free RSS feeds for any public account.

**Nitter RSS URL format:**
```
https://{nitter-instance}/eenblikopdenos/rss
```

**Known working Nitter instances (as of 2024/2025):**
- `nitter.privacydev.net`
- `nitter.poast.org`
- `nitter.1d4.us`

Note: Nitter instances can be unstable. Implement fallback mechanism or monitor availability.

### Sample Nitter RSS Entry Structure

- `<title>` - Tweet text (truncated)
- `<link>` - Link to original tweet on X/Twitter
- `<dc:creator>` - @eenblikopdenos
- `<pubDate>` - Tweet timestamp (RFC 2822)
- `<guid>` - Tweet URL
- `<description>` - Full tweet text with HTML formatting

### Clustering Considerations

For tweets to cluster correctly with NOS events:

1. **Entity Extraction:** Tweets mentioning NOS article topics (people, places, events) should share entities with NOS articles
2. **Embedding Similarity:** Tweet text about a news topic should have high cosine similarity with NOS article embeddings
3. **Temporal Proximity:** Tweets usually appear within hours of NOS publication
4. **Title/Headline Keywords:** Many tweets quote or reference NOS headlines directly

The existing clustering algorithm (embeddings + TF-IDF + entities) should work well since:
- Tweets discuss the same topics as NOS articles
- Named entities (politicians, locations, organizations) are shared
- Keywords from NOS headlines appear in tweets

## Acceptance Criteria (AC)

- [x] Given the Twitter API for @eenblikopdenos when the scheduler polls, then new tweets are discovered and stored in the database. *(Uses Twitter API v2 instead of Nitter)*
- [x] Given a tweet from @eenblikopdenos when processed, then the full tweet text is stored as article content.
- [x] Given tweets about NOS coverage when event clustering runs, then they are clustered with the corresponding NOS articles about the same topic. *(4/30 tweets correctly clustered via entity cross-matching)*
- [x] Given existing sources when @eenblikopdenos is added, then they continue working without regression.
- [N/A] Given a Nitter instance failure, then fallback instances are attempted (resilience). *(Not applicable - using Twitter API v2)*

## Subtask Checklist

### Research & Testing
- [ ] Test Nitter RSS feed availability and format
- [ ] Verify RSS parsing works with existing feedparser
- [ ] Test that tweet content is extractable from RSS (no additional fetch needed)
- [ ] Verify multiple Nitter instances for fallback

### Implementation
- [ ] Create `backend/app/feeds/eenblikopdenos.py` - Feed reader class
- [ ] Add `rss_eenblikopdenos_url` to `backend/app/core/config.py`
- [ ] Add `eenblikopdenos_rss` source profile to `source_profiles.yaml`
- [ ] Register reader in `backend/app/services/ingest_service.py`
- [ ] Implement Nitter instance fallback mechanism

### Feed Reader Details
```python
# backend/app/feeds/eenblikopdenos.py
class EenBlikOpDeNosReader(FeedReader):
    """
    Reader for @eenblikopdenos X/Twitter account via Nitter RSS.

    This account provides critical commentary on NOS (Dutch public broadcaster)
    coverage, making it valuable for pluralistic news analysis.
    """

    # Fallback Nitter instances in case primary is down
    NITTER_INSTANCES = [
        "nitter.privacydev.net",
        "nitter.poast.org",
        "nitter.1d4.us",
    ]

    @property
    def id(self) -> str:
        return "eenblikopdenos_rss"

    @property
    def source_metadata(self) -> Dict[str, Any]:
        return {
            "name": "Een Blik op de NOS",
            "spectrum": 7,  # Right-leaning/critical of public broadcaster
            "country": "NL",
            "language": "nl",
            "media_type": "social_commentary"
        }

    async def fetch(self) -> List[FeedItem]:
        """Fetch tweets via Nitter RSS with fallback instances."""
        # Try each Nitter instance until one works
        for instance in self.NITTER_INSTANCES:
            try:
                url = f"https://{instance}/eenblikopdenos/rss"
                # ... fetch and parse RSS
                return items
            except Exception:
                continue
        raise FeedUnavailableError("All Nitter instances failed")
```

### Source Profile
```yaml
eenblikopdenos_rss:
  feed_url: https://nitter.privacydev.net/eenblikopdenos/rss
  fetch_strategy: simple  # No JS rendering needed for RSS
  user_agent: Mozilla/5.0 (compatible; News360Fetcher/1.0)
  parser: rss_only  # Tweet content is in RSS, no article fetch needed
  requires_js: false
  cookie_ttl_minutes: 0
  fallback_instances:
    - nitter.poast.org
    - nitter.1d4.us
```

### Spectrum Positioning

- **Spectrum value: 7** (right-of-center, critical perspective)
- Rationale: The account critically examines NOS (spectrum 4, center-left public broadcaster) coverage, often from a right-leaning perspective
- This creates natural contrast with NOS articles in the same event cluster

### Testing & Validation
- [ ] Update unit tests in `backend/tests/unit/test_feeds.py` (reader counts)
- [ ] Test manual ingestion: `curl -X POST localhost:8000/admin/trigger/poll-feeds`
- [ ] Verify tweets stored in database with proper metadata
- [ ] Verify tweets cluster with corresponding NOS articles
- [ ] Test Nitter fallback when primary instance fails

## Testing Requirements

- **RSS test:** Verify Nitter RSS returns valid feed for @eenblikopdenos
- **Fallback test:** Simulate primary instance failure, verify fallback works
- **Integration test:** Run ingestion cycle, verify tweets in database
- **Clustering test:** Verify tweets about NOS coverage cluster with the NOS articles they reference
- **Definition of Done:** @eenblikopdenos tweets successfully ingested and clustered with NOS events

## Technical Notes

### Tweet-to-Article Mapping

Tweets are stored as "articles" with these mappings:
- `guid`: Tweet ID or URL
- `url`: Link to original tweet on X/Twitter
- `title`: First ~100 chars of tweet text
- `summary`: Full tweet text
- `content`: Full tweet text (same as summary for tweets)
- `source_name`: "Een Blik op de NOS"
- `source_metadata`: Includes media_type: "social_commentary"

### Nitter Instance Monitoring

Nitter instances are community-run and can go offline. Consider:
1. Checking instance status before polling
2. Rotating through instances on failure
3. Logging which instance was used for debugging
4. Potentially adding health check endpoint

### Rate Limiting

Nitter instances may rate limit aggressive polling. Consider:
- Polling less frequently (every 30 min instead of 15 min)
- Using respectful User-Agent
- Caching responses appropriately

### Clustering Optimization

To maximize clustering accuracy with NOS articles:
1. **Boost entity weight:** Tweets mentioning same people/places as NOS articles should cluster strongly
2. **Headline matching:** If tweet contains NOS headline keywords, boost similarity
3. **Time window:** Limit clustering to articles published within same 24-48 hour window
4. **Source affinity:** Explicit NOS-EenBlikOpDeNOS clustering affinity boost (see below)

### Source Affinity Boost (Required)

**Problem:** Standard clustering (embedding + TF-IDF + entities) fails to link @eenblikopdenos tweets with NOS articles because:
- Tweets are very short (280 chars) vs. long NOS articles (1000+ chars)
- Content style differs: commentary vs. factual reporting
- Entity overlap is low when tweets don't mention the same proper nouns

**Solution:** Implement source affinity boost in `backend/app/services/event_service.py`:

```python
# In assign_article method, after location/date boost calculation:

# SOURCE AFFINITY: Boost @eenblikopdenos tweets that mention NOS
# to cluster with NOS events (media watchdog commentary)
if article.source_name == "Een Blik op de NOS":
    article_text = (article.title or "") + " " + (article.summary or "")
    mentions_nos = "@NOS" in article_text or "NOS" in article_text.upper()
    if mentions_nos:
        # Check if candidate event has NOS articles
        event_has_nos = any(
            ea.source_name == "NOS" for ea in event_articles_list
        )
        if event_has_nos:
            source_affinity_boost = 0.40  # Strong boost for media watchdog clustering
```

**Logic:**
1. Detect if article is from @eenblikopdenos
2. Check if tweet text mentions "@NOS" or "NOS"
3. Check if candidate event contains NOS articles
4. If all true: apply +0.40 score boost to encourage clustering

**Boost value rationale:**
- 0.40 is aggressive enough to overcome lower embedding/TF-IDF similarity for short tweets
- Combined with base score of 0.20+ (some topic overlap), reaches threshold of 0.60
- Requires minimum semantic overlap - boost alone (0.40 + base 0.03 = 0.43) won't exceed threshold
- **Expected behavior:**
  - Meta-commentary about NOS as organization (no topic overlap) → separate cluster
  - Commentary on specific NOS article about topic X → clusters with that NOS event
- This is intentional: we don't want unrelated content to cluster just because "@NOS" is mentioned

**Acceptance Criteria (additional):**
- [ ] Given a @eenblikopdenos tweet mentioning NOS, when clustering runs, then it receives +0.40 affinity boost for NOS events
- [ ] Given a boosted tweet and NOS event with some topic overlap, when score is computed, then the tweet clusters with the NOS event
- [ ] Given the boost mechanism, when tweet has NO topic overlap with NOS event, then it still creates separate event (boost alone insufficient)

## Dependencies

- Existing RSS ingestion pipeline - operational
- NOS feed reader (Story 1.1) - operational
- Event clustering algorithm - operational
- Nitter instance availability - external dependency

## Risks & Considerations

- **Nitter availability:** Community instances may go offline; implement fallbacks
- **Rate limiting:** Respect Nitter instance rate limits
- **Tweet format:** Tweets are short; may need different content handling than articles
- **Clustering accuracy:** Test thoroughly that tweets cluster with correct NOS articles
- **Media type UI:** Frontend may need to handle "social_commentary" media type differently
- **Legal:** Nitter is a third-party service; ensure compliance with terms

## Implementation Notes

### Special Handling for Tweet Content

Unlike news articles, tweets are:
- Short (max 280 chars, often with links)
- May contain @mentions, hashtags, URLs
- May reference NOS articles by headline quote
- Don't require separate article fetch (content is in RSS)

Consider:
- Expanding t.co shortened URLs
- Extracting quoted headlines for clustering
- Handling retweets/quote tweets appropriately

### Frontend Display

Tweets may need different display treatment:
- Show as "commentary" type in event detail
- Display X/Twitter icon instead of newspaper icon
- Show in "perspectives" section rather than "articles" section

## Story Wrap Up

- **Agent Model Used:** Claude Opus 4.5
- **Date/Time Completed:** 2025-12-22
- **Commit Hash:** (pending user commit)
- **Change Log:**
  - Created `backend/app/feeds/eenblikopdenos.py` - Twitter API v2 feed reader via tweepy
  - Added `twitter_bearer_token` and `twitter_eenblikopdenos_user_id` to config
  - Added all Twitter credential fields to `backend/app/core/config.py`
  - Added `tweepy` to requirements.txt
  - Updated unit tests in `backend/tests/unit/test_feeds.py` (13 readers)
  - Fixed spectrum type bug in `backend/app/routers/events.py` (int→str conversion)
  - **Implemented source affinity boost** in `backend/app/services/event_service.py`:
    - Base boost: +0.20 for @eenblikopdenos tweets mentioning NOS
    - Entity match bonus: +0.10 per shared entity (max +0.30)
    - Type mismatch bypass when entity match confirmed (boost > 0.25)
    - Lower threshold (0.35) for entity-matched source affinity candidates
    - Entity-based candidate expansion: finds NOS events sharing entities with tweet
    - Affinity-based selection: prioritizes entity-matched candidates over regular scoring
- **Clustering Results:**
  - Initial: 0% of tweets clustered with NOS events (all false negatives)
  - After first fix: 50% clustered but with false positives (broad topic matches)
  - Final: **13% clustered (4/30), all correct matches (0 false positives)**
  - Remaining 87% create separate events (meta-commentary without distinctive entity overlap)
- **Cross-Matching Entity Algorithm (Final):**
  - **Distinctive entities:** PERSON (≥10 chars), WORK_OF_ART, FAC, EVENT
  - **Cross-matching:** Entity matches if distinctive in EITHER tweet OR NOS article
  - Handles spaCy labeling inconsistencies (same entity labeled differently across sources)
  - No hardcoded word lists - uses spaCy entity label filtering only
  - Examples of matches:
    - "Geert Wilders" (PERSON ≥10 chars in both)
    - "Gaza-kunstwerk" (FAC in tweet, matched to NOS)
    - "Cemal" (WORK_OF_ART in tweet, matched to NOS)
    - "Chanoeka" (EVENT/FAC)
  - Without entity match: tweet creates separate event (no boost applied)
  - With entity match: source_affinity_boost = 0.30 (0.20 base + 0.10 entity bonus)
- **Additional Implementation Details:**
  - For @eenblikopdenos: only considers events with NOS articles (filters tweet-only events)
  - For @eenblikopdenos: includes archived NOS events in candidate search (commentary on older news)
  - Unarchives events when tweets are added to them
  - Entity-matched affinity candidates bypass minimum LLM score threshold (0.40)

### Manual Steps Required

**Set up Twitter API credentials:**

1. **Create Twitter Developer Account:**
   - Go to https://developer.twitter.com/
   - Sign up for Free tier (1500 tweets/month read access)
   - Create a new Project and App
   - Generate Bearer Token

2. **Add credentials to `.env`:**
   ```bash
   TWITTER_BEARER_TOKEN=your_bearer_token_here
   ```

3. **Initialize the source in database:**
   ```bash
   # Start backend
   make backend-dev

   # Initialize the new source
   curl -X POST http://localhost:8000/admin/sources/initialize
   ```

4. **Test ingestion:**
   ```bash
   curl -X POST http://localhost:8000/admin/trigger/poll-feeds
   ```

### Implementation Notes

- Uses Twitter API v2 via tweepy library
- Free tier: 1500 tweets/month (sufficient for single account)
- Fetches 20 tweets per poll with engagement metrics
- Stores full tweet text in `source_metadata.full_text_from_feed` for clustering
- Cleans t.co URLs from tweet text for readability
- Spectrum value: 7 (right-of-center, critical of public broadcaster)
