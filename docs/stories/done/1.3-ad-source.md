# Story 1.3: Add Algemeen Dagblad (AD) as News Source

**Story ID:** 1.3
**Epic ID:** Epic 1 â€“ RSS Ingestion & NLP Enrichment
**Status:** Done

## Objective

Add Algemeen Dagblad (AD.nl) as a news source to include a major mainstream commercial newspaper perspective, providing broad Dutch news coverage with a center/commercial editorial stance.

## Background/Context

- **Source:** Algemeen Dagblad is one of the largest Dutch daily newspapers
- **Publisher:** DPG Media (same as NU.nl, Volkskrant, Parool, Trouw)
- **RSS Feed:** `https://www.ad.nl/rss.xml`
- **Update Frequency:** Continuously throughout the day
- **Fetch Strategy:** Playwright (DPG Media sites require JavaScript rendering)
- **Paywall:** Partial - premium articles marked with `dpp:paid` attribute in RSS
- **Value:** Mainstream commercial perspective, broad news coverage, one of NL's largest newspapers
- **Editorial Stance:** Center/mainstream commercial

### RSS Feed Analysis

```
Feed URL: https://www.ad.nl/rss.xml
Content-Type: application/rss+xml
Publisher: DPG Media
Language: nl-NL
Premium articles: Marked with dpp:paid="true"
```

### Sample RSS Entry Structure

- `<title>` - Article title
- `<link>` - Article URL
- `<guid>` - Unique identifier
- `<pubDate>` - Publication date
- `<description>` - Article summary
- `<dpp:paid>` - Premium indicator (true/false)
- `<media:content>` - Article image
- `<category>` - Article categories
- `<author>` - Author name

## Acceptance Criteria (AC)

- [x] Given the AD RSS feed URL when the scheduler polls, then new articles are discovered and stored in the database.
- [x] Given an AD article URL when fetched with Playwright, then full article text is extracted.
- [x] Given premium articles in RSS (dpp:paid="true"), then they are skipped during ingestion.
- [x] Given AD articles in the database when event clustering runs, then they are clustered with articles from other sources on the same topic.
- [x] Given existing sources when AD is added, then they continue working without regression.

## Subtask Checklist

### Research & Testing
- [x] Test RSS feed parsing
- [x] Identify DPG Media privacy-wall pattern
- [x] Test Playwright-based article fetch
- [x] Verify content extraction with trafilatura

### Implementation
- [x] Create `backend/app/feeds/ad.py` - Feed reader class
- [x] Add `rss_ad_url` to `backend/app/core/config.py`
- [x] Add `ad_rss` source profile to `source_profiles.yaml`
- [x] Register reader in `backend/app/services/ingest_service.py`
- [x] Implement premium article filtering (dpp:paid check)

### Feed Reader Details
```python
# backend/app/feeds/ad.py
class AdRssReader(FeedReader):
    @property
    def id(self) -> str:
        return "ad_rss"

    @property
    def source_metadata(self) -> Dict[str, Any]:
        return {
            "name": "AD",
            "full_name": "Algemeen Dagblad",
            "spectrum": "center",
            "country": "NL",
            "language": "nl",
            "media_type": "commercial"
        }

    def _is_paid_article(self, entry: Any) -> bool:
        """Check if article is behind paywall using dpp:paid attribute."""
        if hasattr(entry, "dpp_paid"):
            return str(entry.dpp_paid).lower() == "true"
        return False
```

### Source Profile
```yaml
ad_rss:
  feed_url: https://www.ad.nl/rss.xml
  fetch_strategy: playwright
  user_agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
  parser: trafilatura
  requires_js: true
  cookie_ttl_minutes: 0
```

### Testing & Validation
- [x] Unit tests in `backend/tests/unit/test_feeds.py`
- [x] Manual ingestion test
- [x] Verify articles stored with proper metadata
- [x] Verify premium articles are skipped

## Testing Requirements

- **Manual test:** Fetch sample AD article, verify content extraction
- **RSS test:** Verify premium articles are correctly identified and skipped
- **Integration test:** Run ingestion cycle, verify articles in database
- **Clustering test:** Verify articles cluster with same-topic articles from other sources
- **Definition of Done:** AD articles successfully ingested and clustered

## Technical Notes

- AD.nl is a DPG Media property, shares infrastructure with NU.nl, Volkskrant, Parool, Trouw
- Requires Playwright for JavaScript rendering
- DPG Media sites have a privacy-wall that requires cookie consent handling
- Premium articles are marked with `dpp:paid="true"` in RSS and should be skipped
- Image URLs available via `media:content` or `media:thumbnail`

### DPG Media Consent Handling

The Playwright fetcher handles DPG Media consent automatically:
1. First navigates to homepage to accept cookies
2. Looks for "Akkoord" button and clicks it
3. Then navigates to actual article URL

### Spectrum Classification

AD classified as `center`:
- Mainstream commercial newspaper
- Broad appeal, tabloid-style coverage
- Part of DPG Media conglomerate

## Dependencies

- Story 1.4 (Playwright scraping) - complete
- Existing RSS ingestion pipeline - operational

## Risks & Considerations

- **DPG Privacy Wall:** Requires Playwright with consent handling
- **Premium Content:** Must filter out paid articles to avoid incomplete content
- **Volume:** High volume source, expect many articles per day
- **Clustering:** Should cluster well with other mainstream sources

## Story Wrap Up

- **Agent Model Used:** Claude (various versions during initial implementation)
- **Date/Time Completed:** 2024 (part of initial source setup)
- **Commit Hash:** Part of initial commits
- **Change Log:**
  - Created `backend/app/feeds/ad.py` - Feed reader class with premium article filtering
  - Added `rss_ad_url` to `backend/app/core/config.py`
  - Added `ad_rss` source profile to `source_profiles.yaml` (Playwright strategy)
  - Registered reader in `backend/app/services/ingest_service.py`
  - Implemented `_is_paid_article()` method to skip premium content
  - Added image URL extraction from media:content/media:thumbnail
