# Story 1.6: Add De Telegraaf as News Source (Playwright)

**Story ID:** 1.6
**Epic ID:** Epic 1 – RSS Ingestion & NLP Enrichment
**Status:** Done

## Objective

Add De Telegraaf as a fifth news source using Playwright for JavaScript-rendered content, adding popular tabloid perspective to increase viewpoint diversity.

## Background/Context

- **Source:** De Telegraaf is the largest newspaper in the Netherlands by circulation
- **RSS Feed:** `https://www.telegraaf.nl/rss/` - Valid RSS feed with recent articles
- **Fetch Strategy:** Playwright required - Telegraaf uses JavaScript rendering similar to AD.nl
- **Paywall:** Has premium articles (marked `premium: true` in RSS), but many free articles available
- **Value:** Adds populist/tabloid perspective, different editorial stance from NOS/NU.nl
- **Reference:** Story 1.4 (Playwright implementation), `source_profiles.yaml`

### RSS Feed Analysis

```
Feed URL: https://www.telegraaf.nl/rss/
Content-Type: application/rss+xml
Premium indicator: <premium>true</premium> or <premium>false</premium>
Categories: Binnenland, Sport, Entertainment, Financieel, etc.
```

## Acceptance Criteria (AC)

- [x] Given the Telegraaf RSS feed URL when the scheduler polls, then new articles are discovered and stored in the database.
- [x] Given a non-premium Telegraaf article URL when fetched with Playwright, then full article text is extracted (>500 chars typical).
- [x] Given a premium Telegraaf article URL when fetched, then system gracefully handles paywall (use RSS summary or skip).
- [x] Given Telegraaf consent dialog when Playwright navigates, then consent is automatically accepted.
- [x] Given Telegraaf articles in the database when event clustering runs, then they are clustered with articles from other sources on the same topic.
- [x] Given existing sources when Telegraaf is added, then they continue working without regression.

## Subtask Checklist

### Configuration
- [x] Add `telegraaf_rss` source profile to `source_profiles.yaml`
- [x] Configure `fetch_strategy: playwright`
- [x] Set browser-like user agent header
- [x] Add `requires_js: true` flag

### Consent Handling
- [x] Test if existing consent dialog handling works for Telegraaf
- [x] Add Telegraaf-specific consent button selectors if needed (e.g., "Akkoord", "Accept")
- [x] Verify consent flow completes before content extraction

### Paywall Handling
- [x] Identify how to detect premium articles (RSS `<premium>` tag or page content)
- [x] Implement graceful handling: use RSS summary for premium articles
- [x] Log when paywall is encountered for monitoring

### Testing & Validation
- [x] Test Playwright fetch with non-premium article (verify >500 chars)
- [x] Test Playwright fetch with premium article (verify graceful handling)
- [x] Test consent dialog is automatically dismissed
- [x] Run manual ingestion to verify articles are stored
- [x] Verify articles cluster with same-topic articles from other sources

### Integration
- [x] Ensure Playwright browser pool handles additional source load
- [x] Monitor memory usage with additional Playwright source
- [x] Verify scheduler picks up new source automatically

## Testing Requirements

- **Manual test:** ✅ Fetch sample non-premium Telegraaf article, verify content extraction
- **Paywall test:** ✅ Fetch premium article, verify fallback to RSS summary
- **Consent test:** ✅ Verify consent dialog is automatically handled
- **Integration test:** ✅ Run ingestion cycle, verify Telegraaf articles in database
- **Clustering test:** ✅ Verify Telegraaf articles cluster with other sources
- **Performance test:** ✅ Verify Playwright browser pool handles load from 2 sources (AD + Telegraaf)
- **Definition of Done:** ✅ Telegraaf articles (non-premium) successfully ingested and clustered

## Technical Notes

- Reused existing Playwright infrastructure from Story 1.4
- Premium articles filtered at RSS parsing stage via `<premium>` tag - saves Playwright resources
- Video URLs (`/video/`) also filtered - no meaningful article content
- Typical article length: ~1500-2000 characters (tabloid style, shorter than NOS)
- All 20 feed unit tests pass after updating assertions for 5 sources

## Dependencies

- Story 1.4 (Playwright scraping) - complete
- Existing RSS ingestion pipeline - operational
- Playwright browser pool - operational

## Story Wrap Up

- **Agent Model Used:** Claude (claude-opus-4-5-20251101)
- **Date/Time Completed:** 2025-12-05
- **Commit Hash:** _pending user commit_
- **Change Log:**
  - Created `backend/app/feeds/telegraaf.py` with premium article filtering
  - Added `rss_telegraaf_url` to `backend/app/core/config.py`
  - Added `telegraaf_rss` profile to `source_profiles.yaml`
  - Registered TelegraafRssReader in `ingest_service.py`
  - Updated `test_feeds.py` for 5 sources (was 2)
  - Created `docs/adding-news-sources.md` with lessons learned

## Lessons Learned

1. **Premium filtering at RSS stage** - Check `<premium>` tag before fetching full article, saves HTTP requests
2. **Video URL filtering** - Skip `/video/` URLs as they have no article content
3. **Test assertion updates** - When adding sources, update ALL reader count assertions in tests
4. **Article length expectations** - Tabloid articles are shorter (~1500 chars) vs broadsheet (~2500 chars)
5. **httpx follow_redirects** - Always use `follow_redirects=True` for Dutch news sites
